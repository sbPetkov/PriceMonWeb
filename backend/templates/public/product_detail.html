{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }} - Price Tracking | PriceMon{% endblock %}

{% block meta_tags %}
<meta name="description" content="Track {{ product.name }} prices across Bulgarian stores. Current best price: {{ best_price.price_entered }} {{ best_price.currency_entered }} at {{ best_price.store.name }}. Compare prices and save money.">
<meta name="keywords" content="{{ product.name }}, {{ product.brand }}, {{ product.barcode }}, price tracking, Bulgaria, {{ product.category.name }}">
{% endblock %}

{% block og_title %}{{ product.name }} - {{ product.brand }} | PriceMon{% endblock %}
{% block og_description %}Track {{ product.name }} prices. Best price: {{ best_price.price_entered }} {{ best_price.currency_entered }} at {{ best_price.store.name }}. Compare prices across Bulgarian stores.{% endblock %}
{% block og_image %}{% if product.image_url %}{{ product.image_url }}{% else %}https://price-mon.com/images/og-default.jpg{% endif %}{% endblock %}

{% block twitter_title %}{{ product.name }} - {{ product.brand }} | PriceMon{% endblock %}
{% block twitter_description %}Best price: {{ best_price.price_entered }} {{ best_price.currency_entered }} at {{ best_price.store.name }}{% endblock %}
{% block twitter_image %}{% if product.image_url %}{{ product.image_url }}{% else %}https://price-mon.com/images/og-default.jpg{% endif %}{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": "{{ product.name }}",
  "image": {% if product.image_url %}"{{ product.image_url }}"{% else %}[]{% endif %},
  "description": "{{ product.description|default:'Track prices for '|add:product.name|add:' across Bulgarian stores.' }}",
  "brand": {
    "@type": "Brand",
    "name": "{{ product.brand }}"
  },
  "gtin": "{{ product.barcode }}",
  {% if best_price %}
  "offers": {
    "@type": "AggregateOffer",
    "priceCurrency": "EUR",
    "lowPrice": "{{ best_price.price_eur }}",
    "offerCount": "{{ all_prices|length }}",
    "availability": "https://schema.org/InStock",
    "priceValidUntil": "{{ price_valid_until|date:'Y-m-d' }}",
    "seller": {
      "@type": "Organization",
      "name": "Multiple Bulgarian Stores"
    }
  },
  {% endif %}
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ avg_rating|default:'4.5' }}",
    "reviewCount": "{{ total_verifications|default:'10' }}"
  }
}
</script>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Breadcrumb -->
    <nav class="text-sm text-gray-600 mb-6">
        <a href="/" class="hover:text-gray-900">Home</a>
        <span class="mx-2">/</span>
        {% if product.category %}
        <a href="/category/{{ product.category.slug }}" class="hover:text-gray-900">{{ product.category.name }}</a>
        <span class="mx-2">/</span>
        {% endif %}
        <span class="text-gray-900">{{ product.name }}</span>
    </nav>

    <!-- Product Card -->
    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
        <div class="grid md:grid-cols-2 gap-8">
            <!-- Left: Product Image -->
            <div class="flex items-center justify-center bg-gray-50 rounded-lg p-8">
                {% if product.image_url %}
                <img src="{{ product.image_url }}" alt="{{ product.name }}" class="max-w-full max-h-96 object-contain">
                {% else %}
                <div class="text-center text-gray-400">
                    <svg class="w-48 h-48 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <p class="mt-4 text-lg">No image available</p>
                </div>
                {% endif %}
            </div>

            <!-- Right: Product Info -->
            <div>
                <h1 class="text-4xl font-bold text-gray-900 mb-2">{{ product.name }}</h1>

                {% if product.brand %}
                <p class="text-xl text-gray-600 mb-4"><span data-i18n="brand">Brand</span>: <span class="font-semibold">{{ product.brand }}</span></p>
                {% endif %}

                <div class="flex items-center space-x-4 mb-6">
                    {% if product.category %}
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                        {{ product.category.name }}
                    </span>
                    {% endif %}
                    <span class="text-sm text-gray-500"><span data-i18n="barcode">Barcode</span>: {{ product.barcode }}</span>
                </div>

                {% if product.description %}
                <p class="text-gray-700 mb-6 leading-relaxed">{{ product.description }}</p>
                {% endif %}

                <!-- Best Price Display -->
                {% if best_price %}
                <div class="bg-gradient-to-r from-red-50 to-pink-50 rounded-lg p-6 mb-6 border-2 border-red-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1" data-i18n="bestPriceAt">Best Price Found At</p>
                            <p class="text-2xl font-bold text-gray-900">{{ best_price.store.name }}</p>
                            {% if best_price.store.city %}
                            <p class="text-sm text-gray-500">{{ best_price.store.city }}</p>
                            {% endif %}
                        </div>
                        <div class="text-right">
                            <div class="price-badge">
                                {{ best_price.price_entered }} {{ best_price.currency_entered }}
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Updated {{ best_price.created_at|timesince }} ago</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- CTA Buttons -->
                <div class="space-y-4">
                    <!-- Sign Up Button -->
                    <a href="/signup?product={{ product.barcode }}" class="btn-primary w-full text-center block" data-i18n="signUpToTrack">
                        Sign Up to Track This Product
                    </a>

                    <!-- OR Divider -->
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-4 bg-white text-gray-500">OR</span>
                        </div>
                    </div>

                    <!-- Google Sign-In Button -->
                    <div id="google-signin-button" class="flex justify-center"></div>

                    <!-- Sign In Link -->
                    <p class="text-sm text-gray-600 text-center">
                        <span data-i18n="alreadyHaveAccount">Already have an account?</span>
                        <a href="/login" class="text-blue-600 hover:underline font-medium" data-i18n="signIn">Sign in</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Comparison Table -->
    {% if all_prices %}
    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6" data-i18n="priceComparison">Price Comparison Across Stores</h2>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b-2 border-gray-200">
                        <th class="text-left py-3 px-4 font-semibold text-gray-700" data-i18n="store">Store</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700" data-i18n="location">Location</th>
                        <th class="text-right py-3 px-4 font-semibold text-gray-700" data-i18n="price">Price</th>
                        <th class="text-right py-3 px-4 font-semibold text-gray-700" data-i18n="lastUpdated">Last Updated</th>
                    </tr>
                </thead>
                <tbody>
                    {% for price in all_prices %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-4 px-4 font-medium text-gray-900">{{ price.store.name }}</td>
                        <td class="py-4 px-4 text-gray-600">{{ price.store.city|default:"N/A" }}</td>
                        <td class="py-4 px-4 text-right">
                            <span class="text-lg font-bold {% if forloop.first %}text-green-600{% else %}text-gray-900{% endif %}">
                                {{ price.price_entered }} {{ price.currency_entered }}
                            </span>
                        </td>
                        <td class="py-4 px-4 text-right text-sm text-gray-500">
                            {{ price.created_at|timesince }} ago
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-6 text-center text-sm text-gray-600">
            <p data-i18n="pricesUserSubmitted">Prices are user-submitted and verified by the community.</p>
            <p class="mt-2">
                <a href="/signup" class="text-blue-600 hover:underline font-medium" data-i18n="signUp">Sign up</a> <span data-i18n="signUpToSubmit">to submit prices and help others save money!</span>
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Price History Chart Placeholder -->
    {% if price_history %}
    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6" data-i18n="priceTrend">Price Trend (Last 30 Days)</h2>

        <div class="relative h-64 flex items-end space-x-2">
            {% for price in price_history %}
            <div class="flex-1 bg-blue-500 rounded-t relative group" style="height: {{ price.height_percent }}%;">
                <div class="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-2 py-1 rounded text-xs whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">
                    {{ price.price_entered }} {{ price.currency_entered }}<br>
                    {{ price.created_at|date:"M d" }}
                </div>
            </div>
            {% endfor %}
        </div>

        <p class="text-center text-sm text-gray-600 mt-4">
            Hover over bars to see details. <a href="/login" class="text-blue-600 hover:underline">Sign in</a> for interactive charts.
        </p>
    </div>
    {% endif %}

    <!-- Related Products -->
    {% if related_products %}
    <div class="bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6" data-i18n="similarProducts">Similar Products</h2>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% for related in related_products %}
            <a href="/products/{{ related.barcode }}" class="group">
                <div class="bg-gray-50 rounded-lg p-4 hover:shadow-md transition-shadow">
                    {% if related.image_url %}
                    <img src="{{ related.image_url }}" alt="{{ related.name }}" class="w-full h-32 object-contain mb-3">
                    {% else %}
                    <div class="w-full h-32 flex items-center justify-center bg-gray-200 rounded mb-3">
                        <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    {% endif %}
                    <h3 class="text-sm font-medium text-gray-900 group-hover:text-blue-600 line-clamp-2">
                        {{ related.name }}
                    </h3>
                    {% if related.brand %}
                    <p class="text-xs text-gray-500 mt-1">{{ related.brand }}</p>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize Google Sign-In (same approach as React Login.tsx)
    (function() {
        // Load the Google Identity Services library
        const script = document.createElement('script');
        script.src = 'https://accounts.google.com/gsi/client';
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);

        script.onload = function() {
            if (window.google) {
                // Initialize Google Sign-In
                window.google.accounts.id.initialize({
                    client_id: '703616712607-mj9p47i65t9gsol47un2nm4srue1p301.apps.googleusercontent.com',
                    callback: function(response) {
                        // Redirect to backend with Google token
                        window.location.href = '/login?google_token=' + response.credential;
                    }
                });

                // Render the button with improved styling
                const buttonContainer = document.getElementById('google-signin-button');
                if (buttonContainer) {
                    window.google.accounts.id.renderButton(
                        buttonContainer,
                        {
                            theme: 'outline',
                            size: 'large',
                            width: buttonContainer.offsetWidth || 350,
                            text: 'continue_with',
                            shape: 'rectangular',
                            logo_alignment: 'left'
                        }
                    );
                }
            }
        };
    })();
</script>
{% endblock %}
